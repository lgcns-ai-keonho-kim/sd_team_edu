# 02. 파싱, 검증, 정규화 실전

## 이 챕터에서 다루는 내용

- 문자열을 안전하게 다루기 위한 실전 규칙
- 정규식 기반 파싱 예시
- LangChain 출력 파서와 결합하는 방법

---

## 1. 파싱은 "필요한 것만" 뽑는 과정

LLM 출력이 길고 복잡할수록, 파싱이 더 중요해집니다.

예를 들어 다음과 같은 출력이 있다고 가정합니다.

```plain
감정=긍정
이유=가격 대비 성능이 좋음
```

우리가 필요한 것은 "감정" 값 하나일 수도 있습니다.
따라서 **필요한 값만 추출**하는 파싱 전략이 핵심입니다.

---

## 2. 정규식 기반 파싱 예시

아래 코드는 `감정=값` 형식만 추출하는 파서입니다.
설계 패턴은 **전략(Strategy)**입니다.

```python
"""
목적: 정규식으로 핵심 값을 추출한다.
설명: 감정=값 형태의 문자열에서 감정만 파싱한다.
디자인 패턴: Strategy
참조: docs/03_llm_text_handling/02_파싱_검증_정규화_실전.md
"""

import re
from dataclasses import dataclass


@dataclass(frozen=True)
class RegexAnswerParser:
    """정규식 기반 파서."""

    pattern: re.Pattern[str]

    def parse(self, text: str) -> str:
        """텍스트에서 감정 값을 파싱한다.

        Args:
            text: LLM 응답 텍스트.

        Returns:
            str: 파싱된 감정 값.
        """
        match = self.pattern.search(text)
        if not match:
            raise ValueError("감정 값을 찾을 수 없습니다.")
        return match.group(1).strip()
```

---

## 3. 검증과 정규화 규칙

- **검증**: 허용된 값(예: 긍정/부정/중립)만 통과
- **정규화**: 대소문자/공백/표현 차이를 통일

예를 들어 "긍정", "긍정적", "Positive" 등을 모두 "긍정"으로 통일하면
후속 로직이 단순해집니다.

---

## 4. LangChain 출력 파서와 결합하기

아래는 LangChain의 기본 출력 파서와 결합하는 개념 예시입니다.

```python
"""
목적: LangChain 출력 텍스트를 정규식 파서로 검증한다.
설명: 출력 파서 후처리 단계에 정규식을 추가한다.
디자인 패턴: Decorator
참조: docs/03_llm_text_handling/02_파싱_검증_정규화_실전.md
"""

from dataclasses import dataclass
from langchain_core.output_parsers import StrOutputParser

from src.examples.regex_answer_parser import RegexAnswerParser


@dataclass(frozen=True)
class ChainWithRegexParser:
    """체인의 출력 후처리를 담당한다."""

    parser: RegexAnswerParser

    def build(self) -> StrOutputParser:
        """기본 출력 파서를 반환한다.

        실제 사용 시에는 LLM 체인 출력에 parser.parse를 적용한다.
        """
        return StrOutputParser()
```

### 사용 예 (개념)

```python
from langchain_core.prompts import PromptTemplate

_prompt = """너는 감정 분류기다. 입력의 전반적 감정을 분류하라.

[라벨 정의]
- 긍정: 만족, 칭찬, 추천 등 긍정적 평가가 중심
- 부정: 불만, 문제 제기, 불편 등 부정적 평가가 중심
- 중립: 정보 전달 중심이거나 긍/부정이 혼합됨

[규칙]
- 출력은 아래 형식만 허용한다.
감정=긍정|부정|중립
- 이유, 설명, 추가 문장 금지.
- 판단이 어렵다면 중립으로 분류한다.

[입력]
{text}

[출력]
감정=긍정|부정|중립"""
prompt = PromptTemplate(
    template=_prompt,
    input_variables=["text"],
)
raw_output = "감정=긍정\n이유=가격이 좋음"
parser = RegexAnswerParser(pattern=re.compile(r"감정=(.+)"))
value = parser.parse(raw_output)
```

---

## 5. 구현 체크리스트

- 정규식 규칙이 과도하게 복잡하지 않은가?
- 파싱 실패 시 재요청 또는 fallback 경로가 있는가?
- 검증 실패 메시지가 원인을 명확히 설명하는가?
- 정규화 결과가 팀 표준과 일치하는가?
