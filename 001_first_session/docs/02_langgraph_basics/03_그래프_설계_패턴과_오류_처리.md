# 03. 그래프 설계 패턴과 오류 처리

## 이 챕터에서 다루는 내용

- LangGraph에서 자주 쓰는 설계 패턴
- 라우팅(분기)와 재시도 전략
- 오류가 전체 그래프를 망치지 않게 하는 방법

---

## 1. 자주 쓰는 설계 패턴

1. **파이프라인(Pipeline)**: 순차적으로 단계 수행
2. **라우터(Router)**: 조건에 따라 다른 노드로 분기
3. **상태 머신(State Machine)**: 상태에 따라 반복/종료

초보자는 먼저 파이프라인에 익숙해지고, 그 다음 라우터와 상태 머신을 적용하는 것이 좋습니다.

---

## 2. 라우팅의 필요성

예를 들어, 입력 텍스트가 너무 짧다면 "보완 질문" 노드로 보내고,
충분히 길다면 "분석" 노드로 보내는 것이 합리적입니다.

이런 분기 처리는 LangGraph의 `add_conditional_edges`로 구현합니다.

---

## 3. LangGraph 라우터 예시

아래 코드는 입력 길이에 따라 분기하는 라우터 그래프 예시입니다.
설계 패턴은 **라우터(Router)**입니다.

```python
"""
목적: 입력 조건에 따라 그래프 흐름을 분기한다.
설명: 조건 함수가 다음 노드를 결정한다.
디자인 패턴: Router
참조: docs/02_langgraph_basics/03_그래프_설계_패턴과_오류_처리.md
"""

from dataclasses import dataclass
from langgraph.graph import StateGraph, END

RouteState = dict[str, str]


@dataclass(frozen=True)
class RouterGraphBuilder:
    """조건 분기 그래프를 생성하는 빌더."""

    def build(self) -> StateGraph:
        """라우터 그래프를 생성한다.

        Returns:
            StateGraph: 실행 가능한 그래프 객체.
        """
        graph = StateGraph(RouteState)
        graph.add_node("short", self._short_path)
        graph.add_node("long", self._long_path)
        graph.add_conditional_edges(
            "router",
            self._route,
            {
                "short": "short",
                "long": "long",
            },
        )
        graph.set_entry_point("router")
        graph.add_edge("short", END)
        graph.add_edge("long", END)
        return graph

    def _route(self, state: RouteState) -> str:
        """입력 길이에 따라 다음 노드를 결정한다."""
        return "short" if len(state["text"]) < 20 else "long"

    def _short_path(self, state: RouteState) -> RouteState:
        """짧은 입력에 대한 처리 경로."""
        return {**state, "path": "짧은 입력 처리"}

    def _long_path(self, state: RouteState) -> RouteState:
        """긴 입력에 대한 처리 경로."""
        return {**state, "path": "긴 입력 처리"}
```

---

## 4. 오류 처리의 기본 원칙

- 오류는 "숨기기"가 아니라 "격리"한다.
- 실패한 노드는 상태에 **명시적으로 실패 표시**를 기록한다.
- 재시도는 무한 루프가 되지 않도록 제한한다.

이 원칙을 지키면 LangGraph 기반 시스템이 쉽게 무너지지 않습니다.

---

## 5. 구현 체크리스트

- 분기 조건과 라우팅 키가 문서화되어 있는가?
- 재시도 횟수와 종료 조건이 명확한가?
- 오류가 상태에 기록되어 추적 가능한가?
- 분기/종료 경로가 모두 연결되어 있는가?
