# 03. 생성 단계 설계

## 이 챕터에서 배우는 것

- 생성 단계의 역할과 책임(서비스 수준)
- 근거 기반 답변 생성 규칙
- 출력 포맷과 스트리밍 설계

---

## 1. 생성 단계의 역할

생성 단계는 **검색/후처리 결과를 사용자 답변으로 변환**합니다.
핵심은 **근거 기반 답변**과 **일관된 포맷 유지**입니다.

---

## 2. 그래프 노드 설계(생성~스트리밍 구간)

생성~스트리밍 구간은 다음 **분리된 노드**로 구성됩니다.

- `generate`: LLM 답변 생성
- `stream_answer`: 답변 토큰 스트리밍
- `stream_sources`: 근거 문서 스트리밍

> 반드시 **검색 성공 → LLM 응답 스트리밍 → 근거 문서 스트리밍** 순서를 보장합니다.

---

## 3. 입력 인터페이스

생성 단계는 다음 입력을 받는다고 가정합니다.

- `question`: 사용자 질문
- `contexts`: 최종 컨텍스트 목록
- `constraints`: 출력 제한 조건

```json
{
  "question": "환불 절차가 궁금합니다",
  "contexts": [
    {
      "content": "환불은 결제일 기준 7일 이내 ...",
      "metadata": {"source_id": "policy:refund", "language": "ko"},
      "score": 0.91,
      "score_type": "similarity"
    }
  ],
  "constraints": {
    "max_tokens": 512,
    "style": "간단 요약",
    "must_cite": true
  }
}
```

---

## 4. 프롬프트 설계 핵심 요소

- 질문 재진술로 **의도 명확화**
- 문맥 사용 규칙(근거 기반 답변)
- 출력 포맷(요약/목록/표 등)
- 금지된 행동(추측/허위 생성 금지)

### 프롬프트 템플릿(예시)

```text
너는 문서 기반 답변 생성기다.
다음 문맥에 있는 정보만 사용해 답변하라.
근거가 없으면 "정보 부족"이라고 답하라.
출력 형식:
- 요약: 한 문장
- 상세: 3개 이내의 불릿
질문: {question}
문맥:
{contexts}
```

---

## 5. 출력 포맷 설계

- **구조화된 출력**을 기본으로 설계
- JSON 또는 명확한 섹션 구분
- 에러/폴백 상황을 구분할 수 있어야 함

### JSON 출력 예시

```json
{
  "summary": "환불은 결제일 기준 7일 이내 신청 가능합니다.",
  "details": [
    "신청은 고객센터 또는 웹 페이지에서 가능합니다.",
    "정책 문서 기준으로 추가 조건이 있을 수 있습니다."
  ],
  "citations": ["policy:refund"]
}
```

---

## 6. 근거 추적(필수)

생성 단계는 반드시 **근거 문서의 source_id**를 유지해야 합니다.

- `citations`에는 `source_id` 목록을 넣는다
- 근거가 없으면 `citations`는 빈 배열로 처리한다
- `must_cite=true`라도 컨텍스트가 비면 `citations`는 빈 배열 + 폴백 응답을 사용한다

---

## 7. 안전장치

- 근거 없는 답변은 **거절 또는 폴백**
- 민감 정보 노출 방지
- 불확실성 표현 규칙 정의

**권장 규칙**

- 문맥이 부족하면 `"정보 부족"`을 반환
- 출처가 필요한 경우 `source_id`를 반드시 포함
- 금지어/정책 위반 가능성이 있으면 **안전 응답**

---

## 8. 스트리밍 응답 설계(필수)

- 토큰 스트리밍은 **체감 속도 개선**에 유리
- 근거 문서는 **답변 뒤에** 제공하는 것이 안정적
- 스트리밍 중 오류가 나면 **중단 메시지**를 제공

### 스트리밍 순서(필수)

1) 답변 토큰 스트리밍
2) 근거 문서 스트리밍

### 스트리밍 전제 조건

- **검색 성공(컨텍스트 존재)** 시에만 근거 문서 스트리밍을 수행한다
- 컨텍스트가 비어 있으면 **답변 스트리밍만** 수행하고 근거 스트리밍은 생략한다

### 스트리밍 데이터 포맷(권장)

스트리밍 이벤트는 `type`과 `status`를 사용해 **단일 규칙으로 통일**하는 것이 안전합니다.

```text
data: {"type": "token", "content": "환불은", "status": "in_progress", "index": 1}
data: {"type": "token", "content": "결제일", "status": "in_progress", "index": 2}
...
data: {"type": "token", "content": "", "status": "end"}
data: {"type": "references", "items": [{"source_id": "policy:refund"}], "status": "end"}
data: {"type": "DONE"}
```

**권장 필드**

- `type`: 이벤트 종류 (`token`, `references`, `error`, `DONE`)
- `status`: 상태 (`in_progress`, `end`) — `token`/`references` 이벤트에 사용
- `content`: 토큰/메시지 내용(답변 스트리밍용)
- `index`: 토큰 순서(선택)
- `items`: 근거 문서 목록(근거 스트리밍용)

**references 예시(상세)**

```json
{
  "type": "references",
  "items": [
    {
      "source_id": "policy:refund",
      "title": "환불 정책",
      "url": "https://example.com/policy/refund",
      "score": 0.91
    }
  ]
}
```

### DONE(스트리밍 종료) 이벤트

스트리밍이 끝났음을 알리기 위해 **반드시 종료 이벤트**를 전송합니다.

```text
data: {"type": "DONE"}
```

> `token`의 `status: "end"`는 **답변 스트리밍 종료 신호**이고,  
> `references`의 `status: "end"`는 **근거 스트리밍 종료 신호**입니다.  
> `DONE`은 **전체 스트리밍 종료 신호**이며,  
> **응답/근거 스트리밍이 모두 끝난 후**에 전송합니다.

### 스트리밍 노드 분리 예시(개념)

```python
"""
목적: 응답 스트리밍과 근거 스트리밍을 분리한다.
설명: stream_answer 이후에 조건부로 stream_sources를 실행한다.
디자인 패턴: State Machine
"""

def should_stream_sources(state: dict) -> bool:
    """근거 문서 스트리밍 여부를 판단한다."""
    return bool(state.get("contexts"))
```

---

## 9. 생성 품질 평가 기준

- **정확성**: 문맥과 일치하는가?
- **충분성**: 질문에 필요한 정보가 포함되는가?
- **일관성**: 포맷과 톤이 유지되는가?
- **안전성**: 정책 위반이 없는가?

---

## 10. 흔한 실수

- 문맥을 무시하고 답변을 생성
- 출력 포맷이 매번 달라져 **후처리 실패**
- 폴백 메시지가 없어 **공백 응답** 발생

---

## 11. 체크리스트

- 입력 인터페이스가 명확한가?
- 프롬프트가 근거 기반 답변을 강제하는가?
- 출력 포맷이 고정되어 있는가?
- 근거 추적이 포함되어 있는가?
- 폴백 메시지가 정의되어 있는가?
